name: TypeScript Release

on:
  push:
    branches:
      - ma/release

permissions:
  contents: read
  id-token: write # Required for npm provenance

env:
  NODE_VERSION: "22.x"

jobs:
  validate:
    name: "ts: validate"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      NODE_OPTIONS: --max-old-space-size=6144

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm --filter ampersend-sdk build

      - name: Lint
        run: pnpm --filter ampersend-sdk lint

      - name: Format
        run: pnpm --filter ampersend-sdk format

      - name: Type check
        run: pnpm --filter ampersend-sdk typecheck

      - name: Test
        run: pnpm --filter ampersend-sdk test

  verify-version:
    name: "ts: verify version"
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read package.json version
        id: package
        run: |
          VERSION=$(node -p "require('./typescript/packages/ampersend-sdk/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

  publish:
    name: "ts: publish to npm"
    runs-on: ubuntu-latest
    needs: [validate, verify-version]
    environment:
      name: npm
      url: https://www.npmjs.com/package/@edgeandnode/ampersend-sdk

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package
        run: pnpm --filter ampersend-sdk build

      - name: Determine publish tag
        id: publish-tag
        run: |
          echo "tag=alpha" >> $GITHUB_OUTPUT
          echo "Publishing with tag: alpha"

      - name: Publish to npm
        run: pnpm --filter ampersend-sdk publish --no-git-checks --access public --tag ${{ steps.publish-tag.outputs.tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
